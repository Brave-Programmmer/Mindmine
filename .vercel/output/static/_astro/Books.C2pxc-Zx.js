import{j as e}from"./jsx-runtime.D_zvdyIk.js";import{r as o}from"./index.B7y88wuR.js";import{q as Y,c as D,e as Z,f as P,d as C,h as _,i as ee,j as te,k as se,g as H}from"./firebase.Dme28GWg.js";import{u as W}from"./authStore.CYTjUqjB.js";const re=["12px","14px","16px","18px","20px","24px","28px"],ae=s=>{if(!s)return"";let x=s.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>").replace(/\*(.+?)\*/g,"<em>$1</em>");return x=x.replace(/\n/g,"<br/>"),x},O=({value:s,onChange:x,onSave:T,isSaving:b=!1})=>{const[A,B]=o.useState("16px"),[i,g]=o.useState(!1),[w,f]=o.useState(!1),p=o.useRef(null),S=()=>{const a=p.current;if(!a)return;const{selectionStart:r,selectionEnd:n}=a;s.substring(r,n);const c=s.substring(r-2,r),h=s.substring(n,n+2);g(c==="**"&&h==="**");const m=s.substring(r-1,r),y=s.substring(n,n+1);f(m==="*"&&y==="*")};o.useEffect(()=>{const a=p.current;if(!a)return;const r=()=>S();return a.addEventListener("select",r),a.addEventListener("keyup",r),()=>{a.removeEventListener("select",r),a.removeEventListener("keyup",r)}},[s]);const j=a=>{const r=p.current;if(!r)return;const n=r.selectionStart,c=r.selectionEnd,h=s.substring(n,c);let m=s;a==="**"?i?(m=s.substring(0,n-2)+h+s.substring(c+2),r.selectionStart=n-2,r.selectionEnd=c-2,g(!1)):(m=s.substring(0,n)+"**"+h+"**"+s.substring(c),r.selectionStart=n+2,r.selectionEnd=c+2,g(!0)):a==="*"&&(w?(m=s.substring(0,n-1)+h+s.substring(c+1),r.selectionStart=n-1,r.selectionEnd=c-1,f(!1)):(m=s.substring(0,n)+"*"+h+"*"+s.substring(c),r.selectionStart=n+1,r.selectionEnd=c+1,f(!0))),x(m),setTimeout(()=>{r.focus()},0)},k=a=>{B(a.target.value)},v=s.trim()?s.trim().split(/\s+/).length:0;return e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex gap-3 items-center",children:[e.jsx("button",{type:"button","aria-pressed":i,onClick:()=>j("**"),className:`px-3 py-1 rounded border ${i?"bg-rose-500 text-white border-rose-600":"border-gray-300"}`,title:"Bold (Wrap selected text with **)",children:e.jsx("b",{children:"B"})}),e.jsx("button",{type:"button","aria-pressed":w,onClick:()=>j("*"),className:`px-3 py-1 rounded border ${w?"bg-rose-500 text-white border-rose-600":"border-gray-300"}`,title:"Italic (Wrap selected text with *)",children:e.jsx("em",{children:"I"})}),e.jsxs("label",{className:"flex items-center gap-2 text-sm",children:["Font Size:",e.jsx("select",{value:A,onChange:k,className:"border rounded px-2 py-1",children:re.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsx("button",{type:"button",onClick:()=>T(s),disabled:b,className:"ml-auto bg-rose-600 text-white px-4 py-1 rounded hover:bg-rose-700 disabled:opacity-50",children:b?"Saving...":"Save"})]}),e.jsx("textarea",{ref:p,className:"w-full border border-gray-300 rounded p-3 resize-y font-sans",style:{fontSize:A},rows:12,value:s,onChange:a=>x(a.target.value),placeholder:"Start typing your chapter here..."}),e.jsxs("div",{className:"text-right text-sm text-gray-500",children:["Word count: ",v]}),e.jsxs("div",{className:"border border-gray-300 rounded p-3 bg-gray-50 max-h-60 overflow-auto prose prose-sm prose-rose",children:[e.jsx("h3",{className:"mb-2 font-semibold",children:"Preview"}),e.jsx("div",{dangerouslySetInnerHTML:{__html:ae(s)}})]})]})},ce=()=>{const[s,x]=o.useState([]),[T,b]=o.useState(!0),[A,B]=o.useState(null),[i,g]=o.useState(null),[w,f]=o.useState(!1),[p,S]=o.useState(!1),j=W(t=>t.email),k=W(t=>t.isAuthenticated),[v,a]=o.useState(""),[r,n]=o.useState(""),[c,h]=o.useState(!1),[m,y]=o.useState(null),[R,F]=o.useState([]),[z,E]=o.useState(null),[$,I]=o.useState("");o.useEffect(()=>{if(!k||!j){x([]),b(!1);return}const t=Y(D(C,"books")),l=Z(t,d=>{const M=d.docs.map(N=>({id:N.id,...N.data()})).filter(N=>N.email===j);x(M),b(!1)},d=>{console.error("Error loading books:",d),B("Failed to load books"),b(!1)});return()=>l()},[j,k]);const q=async()=>{S(!0);try{await new Promise(t=>setTimeout(t,1500)),alert("Saved successfully!")}catch{alert("Save failed.")}finally{S(!1)}},L=async t=>{const d=(await H(D(C,"books",t,"chapters"))).docs.map(u=>({id:u.id,...u.data()}));F(d)},G=async t=>{const l=await H(t);if(l.empty)return;const d=l.docs.map(u=>_(u.ref));await Promise.all(d)},V=async t=>{if(confirm("Are you sure you want to delete this book?"))try{const d=P(C,"books",t),u=D(d,"chapters");await G(u),await _(d),x(M=>M.filter(N=>N.id!==t))}catch(d){console.error("Failed to delete book:",d),alert("Failed to delete the book.")}},J=async t=>{g(t),f(!0),a(""),n(""),y(null),F([]),await L(t.id)},K=()=>{g(null),f(!1),F([]),E(null),I("")},Q=async t=>{if(t.preventDefault(),!!i){if(!v.trim()){y("Chapter title cannot be empty.");return}h(!0),y(null);try{const l=D(C,"books",i.id,"chapters");await ee(l,{title:v.trim(),content:r.trim(),createdAt:te()}),a(""),n(""),await L(i.id)}catch(l){console.error("Error creating chapter:",l),y("Failed to create chapter. Try again.")}finally{h(!1)}}},U=(t,l)=>{E(t),I(l)},X=async t=>{if(i)try{const l=P(C,"books",i.id,"chapters",t);await se(l,{content:$}),E(null),I(""),await L(i.id)}catch(l){console.error("Error updating chapter:",l),alert("Failed to save chapter content.")}};return e.jsxs("div",{children:[e.jsxs("main",{className:"container mx-auto px-4 py-12",children:[e.jsx("h1",{className:"text-4xl font-bold text-rosewood mb-8 text-center",children:"My Books"}),T?e.jsx("p",{className:"text-center text-taupe",children:"Loading books..."}):s.length===0?e.jsxs("div",{className:"text-center text-taupe",children:[e.jsx("p",{className:"text-xl",children:"No books available yet."}),e.jsx("p",{className:"mt-2",children:"Start by creating your first book!"})]}):e.jsx("div",{className:"flex flex-col gap-6 items-center justify-center",children:s.map(t=>e.jsx("div",{className:"w-full md:w-4/5 bg-white rounded-xl shadow-lg hover:shadow-xl transition p-4 md:p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6 items-center md:items-start",children:[e.jsxs("div",{className:"relative w-24 md:w-36 aspect-[2/3] flex-shrink-0 group",children:[e.jsx("div",{className:"absolute left-0 top-0 h-full w-4 bg-neutral-800 rounded-l-md shadow-inner z-10"}),e.jsx("div",{className:`h-full w-full pl-4 rounded-r-md ${t.coverImage} shadow-inner border border-black/10`,role:"img"}),e.jsx("div",{className:"absolute bottom-0 left-4 right-0 bg-black/40 text-white text-xs px-2 py-1 rounded-tr-md",children:t.title})]}),e.jsxs("div",{className:"flex-1 text-center md:text-left",children:[e.jsx("h2",{className:"text-2xl font-bold text-rosewood mb-1",children:t.title}),e.jsxs("p",{className:"text-taupe mb-1",children:["by ",t.author]}),e.jsx("p",{className:"text-taupe mb-1",children:t.genre}),e.jsx("p",{className:"text-taupe text-sm mb-3 line-clamp-3",children:t.synopsis}),e.jsx("p",{className:"text-sm text-taupe border-t border-gold/20 pt-2",children:new Date(t.createdAt).toLocaleDateString()}),e.jsxs("div",{className:"flex justify-center md:justify-end gap-2 mt-4",children:[e.jsx("button",{onClick:()=>J(t),className:"px-4 py-2 text-sm bg-rose-100 text-rose-700 rounded hover:bg-rose-200 transition",children:"🡪 View"}),e.jsx("button",{onClick:()=>V(t.id),className:"px-4 py-2 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition",children:"🗑️ Delete"})]})]})]})},t.id))})]}),w&&i&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl relative overflow-y-auto max-h-[90vh]",children:[e.jsx("button",{onClick:K,className:"absolute top-2 right-2 text-gray-500 hover:text-gray-700","aria-label":"Close modal",children:"✕"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-2 text-rosewood",children:i.title}),e.jsxs("p",{className:"text-taupe mb-1",children:["Author: ",i.author]}),e.jsxs("p",{className:"text-taupe mb-1",children:["Genre: ",i.genre]}),e.jsx("p",{className:"text-taupe mb-3",children:i.synopsis})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-rosewood mb-2",children:"Create New Chapter"}),e.jsxs("form",{onSubmit:Q,className:"flex flex-col gap-2",children:[e.jsx("input",{type:"text",placeholder:"Chapter Title",className:"border border-gray-300 rounded px-3 py-2",value:v,onChange:t=>a(t.target.value),disabled:c}),e.jsx(O,{value:r,onChange:n,onSave:q,isSaving:p}),m&&e.jsx("p",{className:"text-red-600 text-sm",children:m}),e.jsx("button",{type:"submit",className:"bg-rose-500 text-white px-4 py-2 rounded hover:bg-rose-600 transition",disabled:c,children:c?"Creating...":"Add Chapter"})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-rosewood mb-2",children:"Chapters"}),R.length===0?e.jsx("p",{className:"text-taupe text-sm",children:"No chapters yet."}):e.jsx("div",{className:"space-y-4",children:R.map(t=>e.jsxs("div",{className:"border border-gray-200 p-4 rounded",children:[e.jsx("h4",{className:"font-semibold text-rosewood",children:t.title}),z===t.id?e.jsxs(e.Fragment,{children:[e.jsx(O,{value:$,onChange:I,onSave:q,isSaving:p}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsx("button",{className:"bg-green-500 text-white px-3 py-1 rounded",onClick:()=>X(t.id),children:"Save"}),e.jsx("button",{className:"bg-gray-300 px-3 py-1 rounded",onClick:()=>E(null),children:"Cancel"})]})]}):e.jsx("div",{className:"prose max-w-none mt-2",dangerouslySetInnerHTML:{__html:t.content}}),z!==t.id&&e.jsx("button",{className:"mt-2 text-sm text-blue-600 hover:underline",onClick:()=>U(t.id,t.content),children:"✏️ Edit"})]},t.id))})]})]})})]})};export{ce as default};
