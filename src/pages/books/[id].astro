---
export const prerender = false;

import Layout from "../../layouts/Layout.astro";
import { collection, doc, getDoc, getDocs } from "firebase/firestore";
import { db } from "../../firebase";
import CustomBook from "../../components/CustomBook";

type Book = {
  id: string;
  title: string;
  author: string;
  genre: string;
  synopsis: string;
  email: string;
  coverImage: string;
  totalChapters: number;
  createdAt: any;
};

type Chapter = {
  id: string;
  title: string;
  content: string;
  createdAt: any;
};

const { params } = Astro;
const id = params.id as string;

let book: Book | null = null;
let chapters: Chapter[] = [];

try {
  const docRef = doc(db, "books", id);
  const docSnap = await getDoc(docRef);
  if (docSnap.exists()) {
    const bookData = docSnap.data();
    book = { id, ...bookData } as Book;

    const chaptersSnapshot = await getDocs(
      collection(db, "books", id, "chapters")
    );
    chapters = chaptersSnapshot.docs
      .map((doc) => {
        const data = doc.data() as Omit<Chapter, "id">;
        return {
          id: doc.id,
          ...data,
        };
      })
      .sort(
        (a, b) => (a.createdAt?.seconds ?? 0) - (b.createdAt?.seconds ?? 0)
      );
  }
} catch (err) {
  console.error(
    "Error loading book:",
    err instanceof Error ? err.message : err
  );
}
---

{
  book ? (
    <Layout title={book.title}>
      <CustomBook chapters={chapters} book={book} client:load />
    </Layout>
  ) : (
    <Layout title="Book Not Found">
      <section class="text-center py-20 text-gray-600">
        <h1 class="text-4xl font-bold mb-4">ðŸ“š Book Not Found</h1>
        <p>The requested book does not exist or has been deleted.</p>
      </section>
    </Layout>
  )
}
